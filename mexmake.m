addpath('src')
output_path = [pwd '/bin'];
cd src

try
	
	libdeflate_path_lib = ['-L' pwd '/extlib/libdeflate/x64/win'];
	pthreadsw32_path_lib = ['-L' pwd '/extlib/pthreads-win32/lib/x64'];
	pthreadsw32_path_include = ['-I' pwd '/extlib/pthreads-win32/include'];
	
	sources = {'getmatvar_.c',...
			'mexSet.c',...
			'cleanup.c',...
			'createDataObjects.c',...
			'ezq.c',...
			'fillDataObjects.c',...
			'getDataObjects.c',...
			'getSystemInfo.c',...
			'init.c',...
			'navigate.c',...
			'numberHelper.c',...
			'placeChunkedData.c',...
			'placeData.c',...
			'readMessage.c',...
			'superblock.c',...
			'utils.c',...
			'extlib/thpool/thpool.c'};
	
	
	if(strcmp(mex.getCompilerConfigurations('C','Selected').ShortName, 'mingw64'))
		
        sources = [sources,{'extlib/mman-win32/mman.c'}];
        
        mex(libdeflate_path_lib, pthreadsw32_path_lib, '-llibdeflate','-llibpthreadGC2',...
			'-g', '-v', 'CFLAGS="$CFLAGS -std=c11 -lpthread"', '-outdir', output_path ,...
			sources{:})
	elseif(startsWith(mex.getCompilerConfigurations('C','Selected').ShortName, 'MSVC'))
		
        sources = [sources,{'extlib/mman-win32/mman.c'}];
        
        mex(libdeflate_path_lib, pthreadsw32_path_lib, pthreadsw32_path_include,...
			'-llibdeflate', '-lpthreadVC2', ...
			'-g', '-v', 'CFLAGS="$CFLAGS -std=c11"', '-outdir', output_path ,...
			sources{:})
	elseif(strcmp(mex.getCompilerConfigurations('C','Selected').ShortName, 'gcc'))
		
        sources = [sources,{'extlib/libdeflate/x64/unix/libdeflate.a'}];
        
        libdeflate_path_lib = ['-L' pwd '/extlib/libdeflate/x64/unix'];
		mex('-lpthread', ...
			'-O', '-v', 'CFLAGS="$CFLAGS -std=c99"', '-outdir', output_path ,...
			sources{:})
	end
	
	cd ..
	clear libdeflate_path pthreadvc2_path clear output_path
	
catch ME
	
	cd ..
	rethrow(ME)
	
end